import z3
from options import Options
from .z3_common import get_collisions


options = Options()
options.add_option('n_collisions', 10, 'Number of colliding strings to create')
options.add_option('length', 10, 'Length of strings to create')
options.add_option('hash_table_size', 256, 'Size of target hash table')
options.add_option('target', 'hello', 'Preimage of desired hash value')

DESCRIPTION = 'Produces hash collisions for the Longitudinal Redundancy Check hash function'


def run(generator, output):
    ret = get_collisions(z3lrc, options['target'], options['length'],
                         options['n_collisions'], options['hash_table_size'])
    output.output(ret)


def z3lrc(bytes, hash_table_size):
    lrc = 0
    for byte in bytes:
        lrc = (lrc + z3.ZeroExt(24, byte)) & 0xff
    lrc = (((lrc ^ 0xff) + 1) & 0xff)
    return lrc % hash_table_size
